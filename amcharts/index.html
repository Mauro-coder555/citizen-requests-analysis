<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gráficos KPI</title>
  <style>
    #chartdiv, #chartdiv2 {
      width: 100%;
      height: 500px;
      margin-bottom: 20px; /* Espacio entre gráficos */
    }
  </style>

  <!-- AmCharts Resources -->
  <script src="https://cdn.amcharts.com/lib/5/index.js"></script>
  <script src="https://cdn.amcharts.com/lib/5/xy.js"></script>
  <script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>
</head>
<body>

  <!-- Div para el gráfico de solicitudes resueltas -->
  <div id="chartdiv"></div>

  <!-- Div para el gráfico de barras apiladas -->
  <div id="chartdiv2"></div>

  <script>
    // Gráfico de solicitudes resueltas
    am5.ready(function() {
      // Crear el elemento root
      var root = am5.Root.new("chartdiv");

      // Aplicar tema animado
      root.setThemes([am5themes_Animated.new(root)]);

      // Crear el gráfico XY
      var chart = root.container.children.push(am5xy.XYChart.new(root, {
        panX: false,
        panY: false,
        paddingLeft: 0,
        layout: root.verticalLayout
      }));

      // Crear ejes X y Y
      var xRenderer = am5xy.AxisRendererX.new(root, { minorGridEnabled: true });
      var xAxis = chart.xAxes.push(am5xy.CategoryAxis.new(root, { categoryField: "category", renderer: xRenderer }));
      var yAxis = chart.yAxes.push(am5xy.ValueAxis.new(root, { renderer: am5xy.AxisRendererY.new(root, { strokeOpacity: 0.1 }) }));

      function makeSeries(name, fieldName) {
        var series = chart.series.push(am5xy.ColumnSeries.new(root, { name: name, xAxis: xAxis, yAxis: yAxis, valueYField: fieldName, categoryXField: "category" }));
        series.columns.template.setAll({ tooltipText: "{name}, {categoryX}:{valueY}" });
        series.appear();
      }

      fetch("get_kpi_tiempo_resolucion")
        .then(response => response.json())
        .then(data => {
          const groupedData = {};
          data.forEach(item => {
            const year = item.año;
            const quarter = item.trimestre;
            const category = `${year} - T${quarter}`;
            if (!groupedData[category]) {
              groupedData[category] = { category: category, solicitudes_resueltas: 0 };
            }
            groupedData[category].solicitudes_resueltas += item.solicitudes_resueltas;
          });
          const processedData = Object.values(groupedData);
          xAxis.data.setAll(processedData);
          makeSeries("Solicitudes Resueltas", "solicitudes_resueltas");
          chart.series.each(series => { series.data.setAll(processedData); });
          chart.appear(1000, 100);
        })
        .catch(error => console.error("Error al obtener los datos:", error));
    });

    // Gráfico de barras apiladas
    am5.ready(function() {
      // Crear el elemento root
      var root2 = am5.Root.new("chartdiv2");

      // Crear chart
      var chart2 = root2.container.children.push(am5xy.XYChart.new(root2, {
        panX: false,
        panY: false,
        wheelX: "panY",
        wheelY: "zoomY",
        paddingLeft: 0,
        layout: root2.verticalLayout
      }));

      // Añadir scrollbar
      chart2.set("scrollbarY", am5.Scrollbar.new(root2, { orientation: "vertical" }));

      // Crear ejes
      var yRenderer = am5xy.AxisRendererY.new(root2, {});
      var yAxis2 = chart2.yAxes.push(am5xy.CategoryAxis.new(root2, { categoryField: "year", renderer: yRenderer }));
      var xAxis2 = chart2.xAxes.push(am5xy.ValueAxis.new(root2, { min: 0, maxPrecision: 0, renderer: am5xy.AxisRendererX.new(root2, { minGridDistance: 40, strokeOpacity: 0.1 }) }));

      // Añadir leyenda
      var legend2 = chart2.children.push(am5.Legend.new(root2, { centerX: am5.p50, x: am5.p50 }));

      // Obtener los datos de la nueva ruta
      fetch("http://127.0.0.1:5000/get_kpi_estado_solicitudes")
        .then(response => response.json())
        .then(data => {
          const groupedData = {};
          const estados = new Set();

          // Agrupar los datos por año y estado
          data.forEach(item => {
            const year = item.año;
            const estado = item.estado;
            if (!groupedData[year]) {
              groupedData[year] = { year: year }; // Inicializa el año
            }
            if (!groupedData[year][estado]) {
              groupedData[year][estado] = 0; // Inicializa el estado
            }
            groupedData[year][estado] += item.cantidad; // Sumar la cantidad
            estados.add(estado); // Agregar el estado a la lista
          });

          const processedData = Object.values(groupedData);
          yAxis2.data.setAll(processedData);

          // Crear las series para cada estado dinámicamente
          estados.forEach(estado => {
            makeSeries(estado, estado);
          });

          // Asignar datos a las series
          chart2.series.each(series => {
            series.data.setAll(processedData);
          });

          chart2.appear(1000, 100);
        })
        .catch(error => console.error("Error al obtener los datos:", error));
    });

    function makeSeries(name, fieldName) {
      var series = chart2.series.push(am5xy.ColumnSeries.new(root2, {
        name: name,
        stacked: true, // Apilar las barras
        xAxis: xAxis2,
        yAxis: yAxis2,
        baseAxis: yAxis2,
        valueXField: fieldName,
        categoryYField: "year"
      }));

      series.columns.template.setAll({
        tooltipText: "{name}, {categoryY}: {valueX}",
        tooltipY: am5.percent(90)
      });

      // Hacer que las columnas aparezcan al cargar
      series.appear();
    }

  </script>

</body>
</html>
